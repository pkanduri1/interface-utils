spring:
  application:
    name: database-script-watcher
  
  datasource:
    url: jdbc:h2:mem:testdb
    driver-class-name: org.h2.Driver
    username: sa
    password: password
  
  h2:
    console:
      enabled: true

logging:
  level:
    com.fabric.watcher: DEBUG
    org.springframework: INFO
    ARCHIVE_SEARCH_AUDIT: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{correlationId:-}] [%X{fileName:-}] [%X{processorType:-}] [%X{eventType:-}] [%X{sessionId:-}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{correlationId:-}] [%X{fileName:-}] [%X{processorType:-}] [%X{eventType:-}] [%X{sessionId:-}] %logger{36} - %msg%n"
  file:
    name: logs/file-watcher.log
  logback:
    rollingpolicy:
      max-file-size: 100MB
      max-history: 30
      total-size-cap: 3GB

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# Swagger/OpenAPI Configuration
springdoc:
  api-docs:
    enabled: true
    path: /api-docs
    groups:
      enabled: true
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    display-request-duration: true
    groups-order: DESC
    operations-sorter: method
    disable-swagger-default-url: true
    use-root-path: true
  group-configs:
    - group: archive-search
      paths-to-match: /api/v1/archive/**
      display-name: Archive Search API
    - group: file-watcher
      paths-to-match: /api/file-watcher/**
      display-name: File Watcher API
    - group: monitoring
      paths-to-match: /api/monitoring/**
      display-name: Monitoring API

file-watcher:
  global:
    max-retry-attempts: 3
    retry-delay: 1000
  
  watch-configs:
    sql-scripts:
      name: "SQL Script Processor"
      processor-type: "sql-script"
      watch-folder: "./sql-scripts"
      completed-folder: "./sql-scripts/completed"
      error-folder: "./sql-scripts/error"
      file-patterns: ["*.sql"]
      polling-interval: 5000
      enabled: true
    
    sqlloader-logs:
      name: "SQL Loader Log Processor"
      processor-type: "sqlloader-log"
      watch-folder: "./sqlloader-logs"
      completed-folder: "./sqlloader-logs/completed"
      error-folder: "./sqlloader-logs/error"
      file-patterns: ["*.log", "*.ctl"]
      polling-interval: 10000
      enabled: false

# Resilience4j Configuration
# Archive Search API Configuration
# This API is only enabled in non-production environments for security
archive:
  search:
    enabled: ${ARCHIVE_SEARCH_ENABLED:false}
    allowed-paths:
      - "./data/archive"
      - "./temp/search"
      - "./sql-scripts"
      - "./sqlloader-logs"
    excluded-paths:
      - "./data/archive/sensitive"
      - "./config"
      - "./logs"
    max-file-size: 104857600  # 100MB
    max-search-results: 100
    search-timeout-seconds: 30
    supported-archive-types:
      - zip
      - tar
      - tar.gz
      - jar
      - war
      - ear
    max-concurrent-operations: 5
    audit-logging-enabled: true
    max-directory-depth: 10
    # Security settings
    path-traversal-protection: true
    file-type-validation: true

resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 30s
        failureRateThreshold: 50
        eventConsumerBufferSize: 10
        recordExceptions:
          - org.springframework.dao.DataAccessException
          - java.io.IOException
          - java.net.SocketException
          - java.net.SocketTimeoutException
          - java.util.concurrent.TimeoutException
    instances:
      database:
        baseConfig: default
        failureRateThreshold: 50
        waitDurationInOpenState: 30s
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        slowCallRateThreshold: 80
        slowCallDurationThreshold: 5s
      filesystem:
        baseConfig: default
        failureRateThreshold: 70
        waitDurationInOpenState: 15s
        slidingWindowSize: 20
        minimumNumberOfCalls: 10
      external:
        baseConfig: default
        failureRateThreshold: 60
        waitDurationInOpenState: 20s
        slidingWindowSize: 15
        minimumNumberOfCalls: 8
  
